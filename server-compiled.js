(()=>{var e={176:(e,t,r)=>{r(142).config();const s={jwtSecret:process.env.JWT_SECRET||"YOUR_secret_key"};e.exports=s},679:(e,t,r)=>{const s=r(121),o=r(344);var{expressjwt:a}=r(779);const n=r(176),i=a({secret:n.jwtSecret,userProperty:"auth",algorithms:["HS256"]});e.exports={signin:async(e,t)=>{try{let r=await s.findOne({email:e.body.email});if(!r)return t.status("401").send({error:"User not found"});if(!r.authenticate(e.body.password))return t.status("401").send({error:"Email and password don't match"});const a=o.sign({_id:r._id},n.jwtSecret);return t.cookie("t",a,{expire:new Date+9999}),t.json({token:a,user:{_id:r._id,name:r.name,email:r.email}})}catch(e){return t.status("401").json({error:"Could not sign in"})}},signout:(e,t)=>(t.clearCookie("t"),t.status("200").json({message:"signed out"})),requireSignin:i,hasAuthorization:(e,t,r)=>{if(!e.profile||!e.auth||e.profile._id!=e.auth._id)return t.status("403").json({error:"User is not authorized"});r()}}},990:(e,t,r)=>{const s=r(938),o=r(672),a=r(616),n=r(147);e.exports={listNewsFeed:async(e,t)=>{e.profile.following.push(e.profile._id);try{let r=await s.find({postedBy:{$in:e.profile.following}}).populate("comments.postedBy","_id name").populate("postedBy","_id name").sort("-created").exec();t.json(r)}catch(e){return t.status(400).json({error:o.getErrorMessage(e)})}},listByUser:async(e,t)=>{try{let r=await s.find({postedBy:e.profile._id}).populate("comments.postedBy","_id name").populate("postedBy","_id name").sort("-created").exec();t.json(r)}catch(e){return t.status("400").json({error:o.getErrorMessage(e)})}},create:async(e,t,r)=>{let i=new a.IncomingForm;i.keepExtensions=!0,i.parse(e,(async(r,a,i)=>{if(r)return t.status(400).json({error:"Image could not be uploaded"});let d=new s(a);d.postedBy=e.profile,i.photo&&(d.photo.data=n.readFileSync(i.photo.filepath),d.photo.contentType=i.photo.type);try{let e=await d.save();t.json(e)}catch(r){return t.status(400).json({error:o.getErrorMessage(r)})}}))},postByID:async(e,t,r,o)=>{try{let a=await s.findById(o).populate("postedBy","_id name").exec();if(!a)return t.status(400).json({error:"Post not found"});e.post=a,r()}catch(e){return t.status(400).json({error:"Could not retrieve use post"})}},photo:(e,t,r)=>(t.set("Content-Type",e.post.photo.contentType),t.send(e.post.photo.data)),isPoster:(e,t,r)=>{if(!e.post||!e.auth||e.post.postedBy._id!=e.auth._id)return t.status("403").json({error:"User is not authorized"});r()},remove:async(e,t)=>{let r=e.post;try{let e=await r.remove();t.json(e)}catch(e){return t.status(400).json({error:o.getErrorMessage(e)})}},like:async(e,t)=>{try{let r=await s.findByIdAndUpdate(e.body.postId,{$push:{likes:e.body.userId}},{new:!0});t.json(r)}catch(e){return t.status(400).json({error:o.getErrorMessage(e)})}},unlike:async(e,t)=>{try{let r=await s.findByIdAndUpdate(e.body.postId,{$pull:{likes:e.body.userId}},{new:!0});t.json(r)}catch(e){return t.status(400).json({error:o.getErrorMessage(e)})}},comment:async(e,t)=>{let r=e.body.comment;r.postedBy=e.body.userId;try{let o=await s.findByIdAndUpdate(e.body.postId,{$push:{comments:r}},{new:!0}).populate("comments.postedBy","_id name").populate("postedBy","_id name").exec();t.json(o)}catch(e){return t.status(400).json({error:o.getErrorMessage(e)})}},uncomment:async(e,t)=>{let r=e.body.comment;try{let o=await s.findByIdAndUpdate(e.body.postId,{$pull:{comments:{_id:r._id}}},{new:!0}).populate("comments.postedBy","_id name").populate("postedBy","_id name").exec();t.json(o)}catch(e){return t.status(400).json({error:o.getErrorMessage(e)})}}}},563:(e,t,r)=>{const s=r(121),o=r(390),a=r(616),n=r(147),i=r(17),d=r(672),u=i.join(__dirname,"../public/images/","images.png");e.exports={create:async(e,t)=>{const r=new s(e.body);try{return await r.save(),t.status(200).json({message:"Successfully signed up!"})}catch(e){return t.status(400).json({error:d.getErrorMessage(e)})}},userByID:async(e,t,r,o)=>{try{let a=await s.findById(o).populate("following","_id name").populate("followers","_id name");if(!a)return t.status("400").json({error:"User not found"});e.profile=a,r()}catch(e){return t.status("400").json({error:"Could not retrieve user"})}},read:(e,t)=>(e.profile.hashed_password=void 0,e.profile.salt=void 0,t.json(e.profile)),list:async(e,t)=>{try{let e=await s.find().select("name email updated created");t.json(e)}catch(e){return t.status(400).json({error:d.getErrorMessage(e)})}},remove:async(e,t)=>{try{let r=e.profile,s=await r.remove();s.hashed_password=void 0,s.salt=void 0,t.json(s)}catch(e){return t.status(400).json({error:d.getErrorMessage(e)})}},update:async(e,t)=>{let r=new a.IncomingForm;r.keepExtensions=!0,r.parse(e,(async(r,s,a)=>{if(r)return t.status(400).json({error:"Photo could not be uploaded"});let i=e.profile;i=o(i,s),i.updated=Date.now(),a.photo&&(i.photo.data=n.readFileSync(a.photo.filepath),i.photo.contentType=a.photo.type);try{await i.save(),i.hashed_password=void 0,i.salt=void 0,t.json(i)}catch(r){return t.status(400).json({error:d.getErrorMessage(r)})}}))},photo:(e,t,r)=>{if(e.profile.photo.data)return t.set("Content-Type",e.profile.photo.contentType),t.send(e.profile.photo.data);r()},defaultPhoto:(e,t)=>t.sendFile(u),addFollowing:async(e,t,r)=>{try{await s.findByIdAndUpdate(e.body.userId,{$push:{following:e.body.followId}}),r()}catch(e){return t.status(400).json({error:d.getErrorMessage(err)})}},addFollower:async(e,t)=>{try{let r=await s.findByIdAndUpdate(e.body.followId,{$push:{followers:e.body.userId}},{new:!0}).populate("following","_id name").populate("followers","_id name").exec();r.hashed_password=void 0,r.salt=void 0,t.json(r)}catch(e){return t.status(400).json({error:d.getErrorMessage(e)})}},removeFollowing:async(e,t,r)=>{try{await s.findByIdAndUpdate(e.body.userId,{$pull:{following:e.body.unfollowId}}),r()}catch(e){return t.status(400).json({error:d.getErrorMessage(e)})}},removeFollower:async(e,t)=>{try{let r=await s.findByIdAndUpdate(e.body.unfollowId,{$pull:{followers:e.body.userId}},{new:!0}).populate("following","_id name").populate("followers","_id name").exec();r.hashed_password=void 0,r.salt=void 0,t.json(r)}catch(e){return t.status(400).json({error:d.getErrorMessage(e)})}},findPeople:async(e,t)=>{let r=e.profile.following;r.push(e.profile._id);try{let e=await s.find({_id:{$nin:r}}).select("name");t.json(e)}catch(e){return t.status(400).json({error:d.getErrorMessage(e)})}}}},672:e=>{e.exports={getErrorMessage:e=>{let t="";if(console.log("err"),e.code)switch(e.code){case 11e3:case 11001:t=(e=>{let t;try{let r=e.message.substring(e.message.lastIndexOf(".$")+2,e.message.lastIndexOf("_1"));t=r.charAt(0).toUpperCase()+r.slice(1)+" already exists"}catch(e){t="Unique field already exists"}return t})(e);break;default:t="Something went wrong"}else for(let r in e.errors)e.errors[r].message&&(t=e.errors[r].message);return t}}},938:(e,t,r)=>{const s=r(185),o=new s.Schema({text:{type:String,required:"Text is required"},photo:{data:Buffer,contentType:String},postedBy:{type:s.Schema.ObjectId,ref:"User"},created:{type:Date,default:Date.now},likes:[{type:s.Schema.ObjectId,ref:"User"}],comments:[{text:String,created:{type:Date,default:Date.now},postedBy:{type:s.Schema.ObjectId,ref:"User"}}]});e.exports=s.model("Post",o)},121:(e,t,r)=>{const s=r(185),o=r(113),a=s.Schema({name:{type:String,trim:!0,required:"Name is required"},email:{type:String,trim:!0,unique:"Email already exists",match:[/.+\@.+\..+/,"Please fill a valid email address"],required:"Email is required"},hashed_password:{type:String,required:"Password is required"},salt:String,updated:Date,created:{type:Date,default:Date.now},about:{type:String,trim:!0},photo:{data:Buffer,contentType:String},following:[{type:s.Schema.ObjectId,ref:"User"}],followers:[{type:s.Schema.ObjectId,ref:"User"}]});a.virtual("password").set((function(e){this._password=e,this.salt=this.makeSalt(),this.hashed_password=this.encryptPassword(e)})).get((function(){return this._password})),a.path("hashed_password").validate((function(e){this._password&&this._password.length<6&&this.invalidate("password","Password must be at least 6 characters."),this.isNew&&!this._password&&this.invalidate("password","Password is required")}),null),a.methods={authenticate:function(e){return this.encryptPassword(e)===this.hashed_password},encryptPassword:function(e){if(!e)return"";try{return o.createHmac("sha1",this.salt).update(e).digest("hex")}catch(e){return""}},makeSalt:function(){return Math.round((new Date).valueOf()*Math.random())+""}},e.exports=s.model("User",a)},646:(e,t,r)=>{const s=r(860),o=r(679),a=s.Router();a.route("/auth/signin").post(o.signin),a.route("/auth/signout").get(o.signout),e.exports=a},940:(e,t,r)=>{const s=r(860).Router(),o=r(563),a=r(679),n=r(990);s.route("/api/posts/feed/:userId").get(a.requireSignin,n.listNewsFeed),s.route("/api/posts/by/:userId").get(a.requireSignin,n.listByUser),s.route("/api/posts/new/:userId").post(a.requireSignin,n.create),s.route("/api/posts/photo/:postId").get(n.photo),s.route("/api/posts/:postId").delete(a.requireSignin,n.isPoster,n.remove),s.route("/api/posts/like").put(a.requireSignin,n.like),s.route("/api/posts/unlike").put(a.requireSignin,n.unlike),s.route("/api/posts/comment").put(a.requireSignin,n.comment),s.route("/api/posts/uncomment").put(a.requireSignin,n.uncomment),s.param("userId",o.userByID),s.param("postId",n.postByID),e.exports=s},7:(e,t,r)=>{const s=r(860).Router(),o=r(563),a=r(679);s.route("/api/users").get(o.list).post(o.create),s.route("/api/users/photo/:userId").get(o.photo,o.defaultPhoto),s.route("/api/users/defaultPhoto").get(o.defaultPhoto),s.route("/api/users/follow").put(a.requireSignin,o.addFollowing,o.addFollower),s.route("/api/users/unfollow").put(a.requireSignin,o.removeFollowing,o.removeFollower),s.route("/api/users/findpeople/:userId").get(a.requireSignin,o.findPeople),s.route("/api/users/:userId").get(a.requireSignin,o.read).put(a.requireSignin,a.hasAuthorization,o.update).delete(a.requireSignin,a.hasAuthorization,o.remove),s.param("userId",o.userByID),e.exports=s},986:e=>{"use strict";e.exports=require("body-parser")},582:e=>{"use strict";e.exports=require("cors")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},779:e=>{"use strict";e.exports=require("express-jwt")},616:e=>{"use strict";e.exports=require("formidable")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},390:e=>{"use strict";e.exports=require("lodash/extend")},185:e=>{"use strict";e.exports=require("mongoose")},113:e=>{"use strict";e.exports=require("crypto")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")}},t={};function r(s){var o=t[s];if(void 0!==o)return o.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,r),a.exports}(()=>{const e=r(860),t=e(),s=r(185),o=r(986),a=r(17),n=r(582);r(142).config();const i=r(7),d=r(646),u=r(940);s.connect(process.env.MONGODB_URI),t.set("views","./public"),t.use(e.static("public")),t.use(n()),t.use(o.json()),t.use(o.urlencoded({extended:!0})),t.use("/",i),t.use("/",d),t.use("/",u),t.get("*",((e,t)=>{t.sendFile(a.join(__dirname)+"/public/","index.html")})),(async()=>{t.listen(process.env.PORT||3e3,console.log("server is running"))})()})()})();